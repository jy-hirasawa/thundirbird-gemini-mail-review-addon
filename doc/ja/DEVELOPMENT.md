# 開発ノート

[English](../en/DEVELOPMENT.md) | 日本語

## プロジェクト概要
これは、Google の Gemini AI を統合して、送信前にメールをレビューする Thunderbird アドオンです。

## アーキテクチャ

### コンポーネント相互作用フロー
1. ユーザーが Thunderbird でメールを作成
2. ユーザーが作成ツールバーの「Gemini Mail Review」ボタンをクリック
3. `popup.js` が開き、即座に分析を開始：
   - ローカルストレージから API キーとエンドポイントを取得
   - 作成詳細（件名、宛先、本文）を取得
   - プロンプトインジェクションを防ぐためにコンテンツをサニタイズ
   - 設定されたエンドポイントを使用して分析プロンプトで Gemini API を呼び出し
   - ポップアップ UI に結果を表示
4. ユーザーがフィードバックをレビューし、編集または送信を決定

### ファイル構造
```
├── manifest.json          # 拡張機能マニフェスト
├── background.js          # バックグラウンドスクリプト（最小限）
├── popup.html/css/js      # メインレビューインターフェース
├── options.html/css/js    # 設定ページ
├── icons/                 # 拡張機能アイコン
├── package.json           # プロジェクトメタデータ
├── README.md              # ユーザードキュメント
├── USAGE.md               # 使用ガイド
└── DEVELOPMENT.md         # このファイル
```

## セキュリティに関する考慮事項

### 実装されたセキュリティ対策

1. **API キーの保護**
   - browser.storage.local に保存（他の拡張機能からはアクセスできません）
   - URL パラメータではなく HTTP ヘッダー経由で送信
   - Google API 以外にはログや送信されません
   - 使用前にフォーマット検証

2. **コンテンツのサニタイズ**
   - 最大コンテンツ長：10,000 文字
   - 潜在的なインジェクションパターンの削除：
     - インストラクションタグ：`[INST]`、`[/INST]`
     - システムタグ：`<<SYS>>`、`<</SYS>>`
     - 行頭の Markdown ヘッダー
     - コードブロック区切り文字
     - 水平線
   - プロンプトインジェクション攻撃を防止

3. **型安全性**
   - さまざまな受信者形式（配列/文字列）を処理
   - 全体的な防御的プログラミング
   - 包括的なエラー処理

### セキュリティスキャン結果
- CodeQL：0 件のアラート
- XSS 脆弱性なし
- インジェクション脆弱性なし
- 認証情報の露出なし

## API 統合

### 設定可能な Gemini API エンドポイント

このアドオンは設定可能な API エンドポイントをサポートしており、ユーザーはさまざまな Gemini モデルを選択できます：

**デフォルトエンドポイント：**
```
https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent
```

**代替モデル：**
- `gemini-pro`: `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent`
- `gemini-1.5-pro`: `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent`
- `gemini-2.0-flash`: `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent`

ユーザーはオプションページでエンドポイントを設定できます。カスタムエンドポイントが設定されていない場合、デフォルト（gemini-2.5-flash）が自動的に使用されます。

### カスタムプロンプトテンプレート

このアドオンは、ユーザーが設定できる最大 3 つのカスタムプロンプトテンプレートをサポートしています：

**機能：**
- 各テンプレートには名前とコンテンツがあります
- テンプレート名はポップアップ UI に表示され、簡単に選択できます
- ユーザーはメールを分析する前にテンプレートを選択および編集できます
- テンプレートは browser.storage.local に保存されます
- プロンプトは分析リクエストの前に追加されます

**ストレージ形式：**
```javascript
{
  customPromptTemplates: {
    template1: { name: 'ビジネスメール', content: 'このメールをレビュー...' },
    template2: { name: 'カジュアルメール', content: '確認する...' },
    template3: { name: '', content: '' }
  }
}
```

**UI フロー：**
1. ユーザーがポップアップを開く → テンプレートセレクターが表示されます
2. ユーザーがドロップダウンからテンプレートを選択（テンプレート名を表示）
3. テンプレートコンテンツが編集可能なテキストエリアに読み込まれます
4. ユーザーは分析前にプロンプトを変更できます
5. 変更されたプロンプトはその特定のレビューに使用されます
6. 設定の元のテンプレートは変更されません

### リクエスト形式
```javascript
{
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'x-goog-api-key': apiKey
  },
  body: JSON.stringify({
    contents: [{
      parts: [{ text: prompt }]
    }]
  })
}
```

### レスポンス形式
```javascript
{
  candidates: [{
    content: {
      parts: [{ text: "分析結果..." }]
    }
  }]
}
```

## テスト戦略

### 手動テストチェックリスト
- [ ] Thunderbird にアドオンをインストール
- [ ] 設定で API キーを設定
- [ ] 接続検証をテスト
- [ ] メールを作成してレビューをトリガー
- [ ] 分析が正しく表示されることを確認
- [ ] エラー処理をテスト（無効な API キー）
- [ ] さまざまなメール形式でテスト
- [ ] 長いメール（10k 文字以上）でテスト
- [ ] ボタンが機能することを確認（メールを編集、とにかく送信）

### 処理されるエッジケース
- 空の件名/本文/受信者
- 非常に長いメール（10k 文字で切り捨て）
- さまざまな形式の受信者（配列 vs 文字列）
- 無効な API キー
- ネットワークエラー
- API レート制限
- 不正な形式の API レスポンス

## 今後の機能強化（スコープ外）

1. **添付ファイルの分析**：メールコンテンツに基づいて添付ファイルの欠落を検出
2. **複数の AI モデル**：他の AI プロバイダー（OpenAI、Claude など）をサポート
3. **バッチレビュー**：複数のドラフトメールを一度にレビュー
4. **履歴**：レビュー履歴と一般的な問題を追跡
5. **提案の適用**：AI の提案をワンクリックで自動適用
6. **オフラインモード**：オフライン使用のために一般的なチェックをキャッシュ
7. **言語サポート**：多言語メール分析
8. **より多くのテンプレートスロット**：3 つ以上のカスタムプロンプトテンプレートをサポート

## 既知の制限事項

1. **API 依存性**：アクティブなインターネット接続と有効な API キーが必要
2. **添付ファイル分析なし**：実際の添付ファイルの存在を確認できません
3. **レート制限**：Google の API レート制限の対象（無料プランで 60 req/min）
4. **プレーンテキストのみ**：プレーンテキスト本文を分析、HTML フォーマットではありません
5. **リアルタイムではない**：入力時ではなく、オンデマンドで分析が行われます
6. **英語に焦点**：AI は英語メールで最も効果的です

## 開発環境

### 要件
- Thunderbird 102.0 以降
- Node.js（構文チェック用）
- Python 3（アイコン生成、Pillow）
- API テスト用のインターネット接続

### 開発コマンド
```bash
# JavaScript 構文を検証
node --check *.js

# JSON を検証
python3 -m json.tool manifest.json

# 拡張機能をパッケージ化（web-ext が必要）
npm run package

# Thunderbird で実行（web-ext が必要）
npm run start
```

### 開発用にロード
1. Thunderbird を開く
2. ツール → アドオンとテーマに移動
3. 歯車アイコンをクリック → アドオンをデバッグ
4. 「一時的なアドオンを読み込む」をクリック
5. このディレクトリから manifest.json を選択

## メンテナンスノート

### バージョン更新
- `manifest.json` と `package.json` のバージョンを一緒に更新
- 機能が変更された場合は README を更新
- リリース前にセキュリティスキャンを実行

### API の変更
Google が Gemini API を変更した場合：
- `popup.js` と `options.js` のエンドポイントを更新
- 必要に応じてリクエスト/レスポンス形式を更新
- 新しいエラーコードのエラー処理を更新
- リリース前に徹底的にテスト

### ブラウザ互換性
- Thunderbird 102+：完全サポート
- 古いバージョン：作成 API 機能が不足している可能性があります
- リリース前に複数の Thunderbird バージョンでテスト

## 貢献ガイドライン

1. 最小限のコード変更を維持
2. 既存のコードスタイルに従う
3. 複雑なロジックにのみコメントを追加
4. コミット前に構文検証を実行
5. CodeQL セキュリティスキャンを実行
6. 動作が変更された場合はドキュメントを更新
7. Thunderbird で手動テスト

## ライセンス
MIT ライセンス - LICENSE ファイルを参照
