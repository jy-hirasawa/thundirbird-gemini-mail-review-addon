# セキュリティポリシー

[English](../en/SECURITY.md) | 日本語

## データストレージとプライバシー

このアドオンは、Thunderbird の browser.storage.local に以下のデータをローカルに保存します：

### 保存されるデータ

1. **API キー**（`geminiApiKeyEncrypted`）
   - Google Gemini API キー
   - **プロファイル固有のキーを使用した AES-GCM で暗号化**（v1.1 の新機能）
   - プロファイル固有のキーは 100,000 回の反復で PBKDF2 を使用して派生
   - 暗号化キーはブラウザランタイム ID とランダムソルトに基づいています
   - Google の Gemini API 以外のサーバーには送信されません
   - レガシーの暗号化されていないキーは次回保存時に自動的に移行されます

2. **API エンドポイント**（`geminiApiEndpoint`）
   - Gemini API エンドポイント URL
   - プレーンテキストで保存（機密情報ではありません）
   - HTTPS プロトコルと Google ドメインのみを確保するために検証されます
   - SSRF 攻撃から保護されています

3. **カスタムプロンプトテンプレート**（`customPromptTemplatesEncrypted`）
   - 名前とコンテンツを持つ最大 3 つのカスタムプロンプトテンプレート
   - **プロファイル固有のキーを使用した AES-GCM で暗号化**（v1.1 の新機能）
   - API キーと同じ暗号化キー
   - プロンプトインジェクション攻撃を防ぐためにサニタイズされます
   - 名前は 100 文字、コンテンツは 5000 文字に制限されています
   - レガシーの暗号化されていないテンプレートは次回保存時に自動的に移行されます

4. **メールキャッシュ**（`geminiCache`）
   - 以下を含むキャッシュされた分析結果：
     - メール件名（サニタイズ済み）
     - メール受信者（サニタイズ済み）
     - メール本文コンテンツ（サニタイズ済み、最大 10,000 文字）
     - AI 分析レスポンス
     - タイムスタンプ
     - 使用されたカスタムプロンプト
   - **各キャッシュエントリはメール ID をキーとして AES-GCM で暗号化**（v1.1 の新機能）
   - メール ID はメールコンテンツの SHA-256 ハッシュ（件名 + 受信者 + 本文）
   - 暗号化により、キャッシュされたデータが特定のメールコンテンツに紐付けられます
   - 最新の 50 エントリに制限
   - キャッシュ保持設定に基づいて自動的に期限切れ（デフォルト：7 日）
   - 設定から手動でクリア可能

5. **最後にチェックされたハッシュ**（`lastCheckedHashes`）
   - 変更検出のために最近チェックされたメールの SHA-256 ハッシュ
   - 最新の 20 エントリに制限
   - ハッシュ値のみを保存、実際のコンテンツは保存しません
   - 暗号化されていません（すでにハッシュ化されています）

6. **プロファイル暗号化ソルト**（`profileEncryptionSalt`）
   - キー派生に使用されるランダムな 16 バイトのソルト
   - プロファイルごとに 1 回生成
   - base64 文字列として保存
   - プロファイル固有の暗号化キーの派生に使用

## 暗号化実装

### 暗号化アルゴリズム

- **アルゴリズム**：AES-GCM（Advanced Encryption Standard - Galois/Counter Mode）
- **キーサイズ**：256 ビット
- **IV サイズ**：12 バイト（96 ビット）、各暗号化でランダムに生成
- **認証**：AES-GCM に組み込まれた認証タグ

### キー派生

1. **プロファイル固有のキー**（設定用）：
   - SHA-256 を使用した PBKDF2 で派生
   - 反復回数：100,000（機密 API キーの高セキュリティ）
   - ソルト：プロファイルごとに一意のランダムな 16 バイトソルト
   - 基礎材料：ブラウザランタイム ID（インストール/プロファイルごとに一意）

2. **メール固有のキー**（キャッシュ用）：
   - SHA-256 を使用した PBKDF2 で派生
   - 反復回数：10,000（パフォーマンスのため低いが、依然として安全）
   - ソルト：一貫性のための固定文字列
   - 基礎材料：メール ID（メールコンテンツの SHA-256 ハッシュ）

### 下位互換性

- レガシーの暗号化されていないデータを自動的に検出して復号化
- 次回保存時に暗号化形式に移行
- 移行中のデータ損失なし

## セキュリティ対策

### 暗号化の利点

1. **データ保護の強化**
   - API キーとカスタムプロンプトはプレーンテキストで保存されなくなりました
   - キャッシュされたメールコンテンツはメール固有のキーで暗号化されています
   - プロファイルディレクトリへの不正アクセスから保護

2. **プロファイル固有の暗号化**
   - 各 Thunderbird プロファイルには独自の暗号化キーがあります
   - あるプロファイルで暗号化されたデータは別のプロファイルでは復号化できません
   - 異なるインストール間で分離を提供

3. **メール固有のキャッシュ暗号化**
   - キャッシュされた各メールは、そのコンテンツから派生したキーで暗号化されています
   - 誰かがキャッシュにアクセスしても、復号化するにはメールコンテンツが必要です
   - キャッシュされたデータに追加のセキュリティレイヤーを提供

### 入力検証とサニタイゼーション

1. **API エンドポイント検証**
   - HTTPS プロトコルを使用する必要があります
   - localhost またはプライベート IP アドレスは使用できません
   - Google API ドメイン（googleapis.com）である必要があります

2. **コンテンツサニタイゼーション**
   - メールコンテンツは API に送信される前にサニタイズされます
   - 一般的なプロンプトインジェクションパターンを削除
   - コンテンツ長を 10,000 文字に制限
   - Markdown コードブロックとインストラクションタグを削除
   - AI ジェイルブレイクパターンを削除（例：「以前の指示を無視」）

3. **カスタムプロンプトのサニタイゼーション**
   - 5,000 文字に制限
   - プロンプトインジェクションパターンを削除
   - テンプレート名は 100 文字に制限

4. **XSS 防止**
   - 分析結果は `textContent` を使用して表示（`innerHTML` ではない）
   - ユーザー生成の HTML はレンダリングされません

### キャッシュセキュリティ

1. **暗号化**（v1.1 の新機能）
   - 各キャッシュエントリはメール ID をキーとして AES-GCM で暗号化
   - メール ID はメールコンテンツから派生（SHA-256 ハッシュ）
   - キャッシュされたデータにコンテンツ固有の暗号化を提供

2. **自動有効期限**
   - キャッシュされたデータは設定された保持期間後に自動的に期限切れ
   - デフォルトの保持：7 日（1～365 日で設定可能）
   - 期限切れエントリは自動的にクリーンアップ

3. **手動キャッシュクリア**
   - ユーザーは設定からすべてのキャッシュデータを手動でクリア可能
   - 誤った削除を防ぐための確認ダイアログを含む

4. **サイズ制限**
   - キャッシュは最新の 50 エントリに制限
   - 制限に達すると、最も古いエントリが自動的に削除されます

## プライバシーに関する考慮事項

### データ送信

- メールコンテンツは分析のために Google の Gemini API に送信されます
- データは HTTPS 経由で送信されます
- [Google のプライバシーポリシー](https://policies.google.com/privacy)の対象となります

### データストレージ

- すべてのデータは Thunderbird のプロファイルディレクトリにローカルに保存されます
- Google の Gemini API 以外の第三者にデータが送信されることはありません
- **API キーとカスタムプロンプトは暗号化されています**（v1.1 の新機能）
- **キャッシュされたメールデータは暗号化されています**（v1.1 の新機能）
- 暗号化キーはプロファイル固有およびメール固有の識別子から派生

### 機密メールに関する推奨事項

機密情報または機密情報を含むメールの場合：

1. **定期的にキャッシュをクリア**
   - 設定の「すべてのキャッシュデータをクリア」ボタンを使用
   - 機密メールを処理した後にキャッシュをクリアすることを検討

2. **キャッシュ保持を減らす**
   - 機密作業の場合はキャッシュ保持を 1 日に設定
   - 設定 → キャッシュ保持日数で設定

3. **キャッシュを無効化**（手動アプローチ）
   - 使用前後にキャッシュをクリア
   - 注意：これにより、メールチェックごとに API 呼び出しが必要になります

4. **プライバシーポリシーを確認**
   - メールコンテンツが Google の AI サービスに送信されることを理解
   - Google のデータ処理慣行を確認

5. **アドオンを使用しないことを検討**
   - 高度に機密性の高いメールの場合、AI レビューを使用しないことを検討
   - 代わりに手動レビューに依存

## セキュリティの脆弱性の報告

このアドオンでセキュリティの脆弱性を発見した場合は、次の方法で報告してください：

1. GitHub issue を `security` タグで開く
2. 脆弱性に関する詳細情報を提供
3. 脆弱性が対処されるまで公開しない

## 制限事項

### ブラウザストレージセキュリティ

- **暗号化が実装されました**（v1.1 の新機能）
  - API キーとカスタムプロンプトは AES-GCM で暗号化
  - キャッシュされたメールデータはメール固有のキーで暗号化
  - 暗号化キーはプロファイルとメールの識別子から派生
- ただし、暗号化キーはランタイム識別子から派生
  - Thunderbird プロファイルにアクセスできる人は依然としてデータにアクセスできる可能性があります
  - 暗号化は追加の保護を提供しますが、エンドツーエンド暗号化ではありません
- ブラウザストレージは、ストレージ権限を持つ他のアドオンからもアクセス可能

### 暗号化の制限事項

- **キー派生**：暗号化キーはブラウザランタイム ID とソルトから派生
  - ユーザー提供のパスワードほど強力ではありません
  - プロファイルディレクトリへのカジュアルなアクセスから保護を提供
  - フルシステムアクセスを持つ決意した攻撃者からは保護しません

- **マスターパスワードなし**：パスワードマネージャーとは異なり、マスターパスワードはありません
  - 使いやすさとセキュリティのトレードオフ
  - ユーザーは毎回パスワードを入力する必要がありません
  - ただし、暗号化は自動的かつ透過的です

### エンドツーエンド暗号化なし

- メールコンテンツは Google のサーバーに送信されます
- コンテンツはエンドツーエンドで暗号化されていません（転送中の HTTPS を超えて）
- Google は、プライバシーポリシーに従ってデータを処理および分析する場合があります

### ローカルシステムセキュリティ

- セキュリティはローカルシステムのセキュリティに依存します
- マルウェアまたはコンピュータへの不正アクセスは、保存されたデータを露出する可能性があります
- 最新のアンチウイルスとセキュリティパッチでシステムを安全に保ちます
- 追加の保護のためにディスク暗号化を使用

## ベストプラクティス

1. **API キー管理**
   - API キーをパスワードのように扱う
   - API キーを共有しない
   - 定期的に API キーをローテーション
   - Google Cloud Console で API キー制限を使用

2. **システムセキュリティ**
   - Thunderbird を最新の状態に保つ
   - オペレーティングシステムを最新の状態に保つ
   - ユーザーアカウントに強力なパスワード/暗号化を使用
   - 機密データを処理する場合はディスク暗号化を有効にする

3. **キャッシュ管理**
   - 機密メールのキャッシュを定期的にクリア
   - セキュリティニーズに基づいて保持期間を調整
   - キャッシュされているデータを監視

4. **プライバシー意識**
   - AI サービスがデータを処理することを理解
   - Google のプライバシーポリシーを定期的に確認
   - 分析のために送信するコンテンツに注意

## 更新とメンテナンス

- セキュリティの改善は継続的です
- 定期的に更新を確認
- セキュリティ関連の修正については変更履歴を確認
- GitHub issue でセキュリティ上の懸念を報告
