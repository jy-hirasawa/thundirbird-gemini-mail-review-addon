# セキュリティ改善の概要

このPRでは、情報保存に関するセキュリティ上の懸念を解決するために、複数の改善を実装しました。

## 実装されたセキュリティ改善

### 1. プロンプトインジェクション攻撃の強化された防止

**問題**: 悪意のあるユーザーがメール本文やカスタムプロンプトにAI指示を上書きする文字列を挿入する可能性がありました。

**解決策**:
- 以下のパターンを検出して削除するサニタイゼーションを追加:
  - "ignore previous instructions"（以前の指示を無視する）
  - "disregard all instructions"（すべての指示を無視する）
  - "forget prior instructions"（以前の指示を忘れる）
- メール本文の最大長を10,000文字に制限
- カスタムプロンプトの最大長を5,000文字に制限

**場所**: `popup.js`, `options.js`

### 2. APIエンドポイント検証（SSRF攻撃の防止）

**問題**: 不適切なAPIエンドポイントURLを使用することで、ローカルネットワークへの不正アクセスやサーバー側リクエストフォージェリ（SSRF）攻撃が可能でした。

**解決策**:
- HTTPSプロトコルのみを許可
- ローカル/プライベートIPアドレス（localhost, 127.0.0.1, 192.168.x.x, 10.x.x.x, 172.16-31.x.x）をブロック
- GoogleのAPI ドメイン（googleapis.com、google.com）のみを許可
- ドメイン検証を`includes()`から`endsWith()`に変更して、`googleapis.com.evil.com`のようなサブドメイン攻撃を防止

**場所**: `options.js`, `popup.js`

### 3. キャッシュ管理機能

**問題**: ユーザーがキャッシュされたメールコンテンツ（件名、受信者、本文）を手動で削除する方法がありませんでした。

**解決策**:
- 設定ページに「すべてのキャッシュデータをクリア」ボタンを追加
- 確認ダイアログで誤削除を防止
- キャッシュには以下が含まれることを明記:
  - メールの件名
  - 受信者
  - メール本文
  - AI分析結果

**場所**: `options.html`, `options.js`

### 4. 入力検証の強化

**問題**: カスタムプロンプトやテンプレート名の長さ制限がなく、潜在的な悪用の可能性がありました。

**解決策**:
- カスタムプロンプトテンプレート名を100文字に制限
- カスタムプロンプト内容を5,000文字に制限
- すべてのカスタムプロンプトを保存前にサニタイズ

**場所**: `options.js`

### 5. セキュリティドキュメントの追加

**問題**: ユーザーが保存されるデータとプライバシーへの影響を十分に理解していない可能性がありました。

**解決策**:
- 包括的な`SECURITY.md`ドキュメントを作成（英語）
- 設定ページにセキュリティに関する通知を追加
- 機密性の高いメールに対するベストプラクティスを記載:
  - 定期的にキャッシュをクリアする
  - キャッシュ保持期間を短く設定する
  - 非常に機密性の高いメールにはアドオンを使用しない

**場所**: `SECURITY.md`, `options.html`

### 6. データ暗号化機能（NEW）

**問題**: APIキー、カスタムプロンプト、キャッシュされたメールデータがプレーンテキストで保存されていました。

**解決策**:
- AES-GCM暗号化を使用した包括的な暗号化システムを実装
- **設定の暗号化**:
  - APIキーをプロファイル固有のキーで暗号化
  - カスタムプロンプトテンプレートをプロファイル固有のキーで暗号化
  - PBKDF2-SHA256を使用した鍵導出（100,000回の反復）
  - ブラウザランタイムIDとランダムなソルトから鍵を生成
- **キャッシュの暗号化**:
  - 各キャッシュエントリをメール固有のキーで暗号化
  - メールIDはメール内容のSHA-256ハッシュから導出
  - PBKDF2-SHA256を使用した鍵導出（10,000回の反復、パフォーマンス重視）
  - メール内容に紐付いた暗号化により、追加のセキュリティ層を提供
- **後方互換性**:
  - 既存の平文データを自動検出
  - 次回保存時に暗号化形式に移行
  - データの損失なし

**暗号化仕様**:
- アルゴリズム: AES-GCM（256ビットキー）
- IV: 12バイト（ランダム生成）
- 認証: GCMモードの内蔵認証タグ

**セキュリティ上の利点**:
- プロファイル分離: 各Thunderbirdプロファイルは固有の暗号化キーを持つ
- コンテンツ結合: キャッシュはメール内容から導出されたキーで暗号化
- 認証付き暗号化: 改ざん検出
- 透過的な暗号化: ユーザーの操作不要

**場所**: `crypto-utils.js`（新規）、`options.js`、`popup.js`、`options.html`、`popup.html`

### 7. 国際化サポート

**問題**: 新しいセキュリティ機能の多言語サポートが必要でした。

**解決策**:
- 英語と日本語の翻訳を追加:
  - キャッシュ管理ラベル
  - クリアキャッシュボタン
  - 確認メッセージ
  - セキュリティに関する説明

**場所**: `_locales/en/messages.json`, `_locales/ja/messages.json`

## セキュリティスキャン結果

### CodeQL分析
- **実行前**: 6件のアラート（URL検証の脆弱性）
- **実行後**: 0件のアラート ✅

すべての既知のセキュリティ脆弱性が解決されました。

## 保存されるデータについて

このアドオンは以下のデータをThunderbirdの`browser.storage.local`にローカル保存します:

1. **APIキー** - **AES-GCM暗号化で保存**（v1.1以降）、プロファイル固有のキーで暗号化
2. **APIエンドポイント** - 検証済みのHTTPS URLのみ（平文）
3. **カスタムプロンプトテンプレート** - **AES-GCM暗号化で保存**（v1.1以降）、サニタイズ済み、長さ制限あり
4. **メールキャッシュ** - **各エントリがメール固有のキーで暗号化**（v1.1以降）、件名、受信者、本文、分析結果（最大50件、自動期限切れ）
5. **最後にチェックしたハッシュ** - 変更検出用のSHA-256ハッシュ（最大20件、暗号化不要）
6. **プロファイル暗号化ソルト** - キー導出用のランダムソルト（v1.1以降）

## ユーザーへの推奨事項

### 機密性の高いメールの場合:
1. ✅ 定期的にキャッシュをクリアする（設定 → キャッシュ管理 → すべてのキャッシュデータをクリア）
2. ✅ キャッシュ保持期間を1日に設定する
3. ✅ 非常に機密性の高い情報には、このアドオンを使用しない

### 一般的なベストプラクティス:
1. ✅ APIキーを秘密にする
2. ✅ Google Cloud ConsoleでAPIキー制限を使用する
3. ✅ システムとThunderbirdを最新の状態に保つ
4. ✅ Googleのプライバシーポリシーを確認する

## 技術的な詳細

### XSS防止
- 分析結果は`textContent`を使用して表示（`innerHTML`は使用せず）
- ユーザー生成のHTMLはレンダリングされません

### データサニタイゼーション
- すべてのメールコンテンツは送信前にサニタイズ
- Markdownコードブロックの削除
- 指示タグの削除（[INST], <<SYS>>など）
- AIジェイルブレイクパターンの削除

### APIセキュリティ
- すべてのAPI呼び出しでHTTPSを強制
- APIキーはリクエストヘッダーで送信
- レート制限とエラー処理を実装

## まとめ

このPRは、情報保存に関するセキュリティ上の懸念に包括的に対処し、以下を提供します:

1. ✅ 強化された入力検証とサニタイゼーション
2. ✅ SSRF攻撃の防止
3. ✅ プロンプトインジェクション攻撃の防止
4. ✅ ユーザー制御可能なキャッシュ管理
5. ✅ 明確なセキュリティドキュメント
6. ✅ すべてのCodeQL脆弱性を解決
7. ✅ **AES-GCM暗号化によるデータ保護（NEW）**
8. ✅ **プロファイル固有の暗号化キー（NEW）**
9. ✅ **メール固有のキャッシュ暗号化（NEW）**

すべての変更は既存の機能を損なうことなく、セキュリティとプライバシーを大幅に向上させます。
