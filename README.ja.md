# Gemini Mail Review - Thunderbird アドオン

Google の Gemini AI を使用してメール送信前にチェックする Thunderbird アドオンです。スペル、文法、トーン、明瞭さ、潜在的な問題についてインテリジェントなフィードバックを得られます。

[English](README.md) | 日本語

## 機能

- 🤖 **AI による分析**: Google の Gemini Pro モデルを使用してメールを分析
- ✅ **包括的なチェック**: スペル、文法、トーン、プロフェッショナリズム、明瞭さをレビュー
- ⚠️ **問題検出**: 添付ファイルの欠落や不明瞭なメッセージなどの潜在的な問題を特定
- 🎯 **使いやすい**: 作成ウィンドウでアドオンアイコンをクリックするだけ
- 🔒 **セキュア**: API キーとキャッシュデータは AES-GCM 暗号化で保護され、Thunderbird にローカル保存
- 📦 **スマートキャッシング**: 同一メール内容への重複した API コールを回避するために自動的にレスポンスをキャッシュ

## インストール

### ソースから

1. このリポジトリをクローンまたはダウンロード
2. Thunderbird を開く
3. **ツール** → **アドオンとテーマ**（または `Ctrl+Shift+A` を押す）
4. 歯車アイコン ⚙️ をクリックして **ファイルからアドオンをインストール** を選択
5. アドオンディレクトリに移動して `manifest.json` ファイルを選択

### 必要要件

- Thunderbird 102.0 以降
- Google Gemini API キー（無料枠あり）

## セットアップ

1. Gemini API キーを取得:
   - [Google AI Studio](https://makersuite.google.com/app/apikey) にアクセス
   - Google アカウントでサインイン
   - **API キーを作成** をクリック
   - 生成されたキーをコピー

2. アドオンの設定:
   - Thunderbird で **ツール** → **アドオンとテーマ** を開く
   - アドオンリストで **Gemini Mail Review** を見つける
   - **オプション** または **設定** をクリック
   - API キーを貼り付ける
   - （オプション）別の Gemini モデルを使用する場合は API エンドポイント URL をカスタマイズ
     - デフォルト: `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent`
   - （オプション）Gemini がメールを分析する方法をカスタマイズするためにカスタムプロンプトテンプレートを追加
     - 最大3つのカスタムプロンプトテンプレートを名前付きで保存できます
     - 各テンプレートはメールレビュー時に選択可能です
     - カスタムプロンプトは分析リクエストの先頭に追加されます
     - 例: "以下のメール本文が、取引先・顧客など会社宛てのメールとして、敬語や言い回しが適切か、失礼・不自然・誤解を招く表現がないか、ビジネスメールとして十分にフォーマルかを確認してください。問題点があれば、理由とあわせて修正案を提示してください。内容の意図は変えないでください。"
   - （オプション）キャッシュ保持期間（日数）を設定（1〜365日）
     - デフォルト: 7日
     - キャッシュされた分析結果を保持する期間を指定します
   - **設定を保存** をクリック
   - （オプション）**接続テスト** をクリックして設定が機能することを確認

## 使い方

1. Thunderbird で通常通りメールを作成
2. 送信前に、作成ウィンドウのツールバーにある **Gemini Mail Review** アイコンをクリック
3. アドオンがテンプレート選択インターフェースで開きます：
   - **カスタムプロンプトテンプレートを選択**: 保存済みのテンプレート（テンプレート 1、2、3）から選択
   - **カスタムプロンプトを編集**: 分析前にプロンプトを確認・修正
   - **メールを分析** をクリックしてレビューを開始
4. アドオンがメールを分析し、結果を表示
   - すでにこの正確なメール（同じ件名、受信者、本文）を分析している場合は、キャッシュされたレスポンスが即座に表示されます
   - キャッシュされた結果を表示する際は「📦 キャッシュから表示中」というインジケーターが表示されます
5. AI からのフィードバックと提案を確認
6. 次のいずれかを選択:
   - **Geminiに再リクエスト**: API から新しい分析を取得（キャッシュされた結果または内容が変更された場合のみ表示）
   - **メールを編集**: ポップアップを閉じて変更を加える
   - **このまま送信**: 送信を続行（メールは自動的には送信されません - まだ送信ボタンをクリックする必要があります）

### キャッシング動作

アドオンは以下のために Gemini レスポンスをインテリジェントにキャッシュします：
- **API コールの節約**: すでに分析したメールへの不要なリクエストを回避
- **高速なフィードバック**: 同じメールを再度開いたときに即座に結果を表示
- **スマート検出**: メールコンテンツが変更されると自動的に検出し、前回の分析を先に表示

**キャッシングの仕組み:**
- 各メールは件名、受信者、本文内容のユニークなハッシュで識別されます
- 各作成タブは最後に分析した内容を追跡し、変更を検出します
- 同じメールを再度分析すると、キャッシュされたレスポンスが即座に表示されます
- **メールを編集して再度チェックすると:**
  - 前回の分析が「⚠️ メール内容が変更されています」というインジケーターと共に最初に表示されます
  - 「Geminiに再リクエスト」ボタンが表示され、更新された内容の新しい分析を取得できます
  - これにより、新しいレビューが必要かどうか判断しながら、前回のフィードバックをすぐに確認できます
- キャッシュは最新の50件のメール分析を保存します（最も古いエントリは自動的に削除されます）
- キャッシュされたレスポンスは設定可能な期間（デフォルト: 7日）保持され、それ以降は自動的に期限切れになります
- キャッシュ保持期間は設定で変更できます（1〜365日）
- キャッシュは browser.storage.local を使用して Thunderbird プロファイルにローカル保存されます

## 分析される内容

アドオンは以下の情報を Gemini に送信して分析します：
- メールの件名
- 受信者
- メール本文（プレーンテキスト）

AI は以下をレビューします：
- スペルと文法エラー
- トーンとプロフェッショナリズム
- 明瞭さと簡潔さ
- 不足している情報
- 潜在的な問題や懸念事項

## プライバシーに関する通知

このアドオンは、分析のためにメールコンテンツを Google の Gemini API に送信します。メールは [Google のプライバシーポリシー](https://policies.google.com/privacy?hl=ja)に従って処理されます。

**セキュリティ機能**:
- API キーとカスタムプロンプトは AES-GCM 暗号化でローカルに保存
- キャッシュされたメールデータはメール固有のキーで暗号化
- プロファイル固有の暗号化により、異なる Thunderbird プロファイル間でデータが隔離されます
- 暗号化キーはプロファイル ID とメール ID から派生
- 詳細は [SECURITY.md](SECURITY.md) をご覧ください

**重要**: Google の AI サービスで処理されることに抵抗がない場合を除き、機密性の高いメールや秘密のメールにはこのアドオンを使用しないでください。

## 開発

### プロジェクト構造

```
.
├── manifest.json       # アドオンマニフェスト
├── background.js       # バックグラウンドスクリプト
├── popup.html         # メインポップアップインターフェース
├── popup.css          # ポップアップスタイル
├── popup.js           # ポップアップロジックと API 統合
├── options.html       # 設定ページ
├── options.css        # 設定ページスタイル
├── options.js         # 設定ページロジック
└── icons/             # アドオンアイコン
```

### ビルド

これは純粋な WebExtension であり、ビルドステップは不要です。インストールセクションで説明されているように拡張機能を読み込むだけです。

### テスト

1. アドオンをインストール（インストールセクションの手順を参照）
2. 設定で API キーを設定
3. テストメールを作成
4. アドオンアイコンをクリックしてレビュー機能をテスト

## トラブルシューティング

### "Gemini API キーを設定してください"
- アドオンの設定に移動して API キーを入力
- キーが保存されていることを確認（成功メッセージが表示されます）

### "API リクエストが失敗しました" または接続エラー
- API キーが正しいことを確認
- インターネット接続を確認
- API レート制限を超えていないことを確認（無料枠には制限があります）
- 設定ページで接続テストを試してみる

### ポップアップが表示されない
- 作成ウィンドウにいることを確認（Thunderbird のメインウィンドウではない）
- 作成ウィンドウを閉じて再度開いてみる
- Thunderbird エラーコンソールでエラーを確認

## ライセンス

MIT ライセンス - 詳細は LICENSE ファイルを参照

## コントリビューション

コントリビューションを歓迎します！お気軽に issue や pull request を送信してください。

## 免責事項

このアドオンは Google や Mozilla と公式に提携しているものではありません。自己責任でご使用ください。
